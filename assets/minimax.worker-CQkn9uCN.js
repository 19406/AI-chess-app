(function(){"use strict";const y={r:[[-1,0],[1,0],[0,-1],[0,1]],n:[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],b:[[-1,-1],[-1,1],[1,-1],[1,1]],q:[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]],k:[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]]};function R(e,t,o){const n=[],s=o==="w"?-1:1;return t>0&&n.push({row:e+s,col:t-1}),t<7&&n.push({row:e+s,col:t+1}),n}function $(e,t,o){const n=[];for(const[s,i]of y.r){let f=t+s,c=o+i;for(;f>=0&&f<=7&&c>=0&&c<=7;){const r=e[f][c];if(n.push({row:f,col:c}),r)break;f+=s,c+=i}}return n}function E(e,t){const o=[];for(const[n,s]of y.n){const i=e+n,f=t+s;i<0||i>7||f<0||f>7||o.push({row:i,col:f})}return o}function Q(e,t,o){const n=[];for(const[s,i]of y.b){let f=t+s,c=o+i;for(;f>=0&&f<=7&&c>=0&&c<=7;){const r=e[f][c];if(n.push({row:f,col:c}),r)break;f+=s,c+=i}}return n}function U(e,t,o){const n=[];for(const[s,i]of y.q){let f=t+s,c=o+i;for(;f>=0&&f<=7&&c>=0&&c<=7;){const r=e[f][c];if(n.push({row:f,col:c}),r)break;f+=s,c+=i}}return n}function F(e,t){const o=[];for(const[n,s]of y.k){const i=e+n,f=t+s;i<0||i>7||f<0||f>7||o.push({row:i,col:f})}return o}const I={r:[[-1,0],[1,0],[0,-1],[0,1]],n:[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],b:[[-1,-1],[-1,1],[1,-1],[1,1]],q:[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]]};function j(e,t,o,n){var r,l,u,a,w,k;const s=[],i=n==="w"?-1:1,f=n==="w"?6:1,c=n==="w"?"b":"w";return((r=e[t+i])==null?void 0:r[o])==null&&(s.push({row:t+i,col:o,isCapture:!1}),t===f&&((l=e[t+2*i])==null?void 0:l[o])==null&&s.push({row:t+2*i,col:o,isCapture:!1})),o>0&&((a=(u=e[t+i])==null?void 0:u[o-1])==null?void 0:a[0])===c&&s.push({row:t+i,col:o-1,isCapture:!0}),o<7&&((k=(w=e[t+i])==null?void 0:w[o+1])==null?void 0:k[0])===c&&s.push({row:t+i,col:o+1,isCapture:!0}),s}function z(e,t,o,n){const s=[],i=n==="w"?"b":"w";for(const[f,c]of I.r){let r=t+f,l=o+c;for(;r>=0&&r<=7&&l>=0&&l<=7;){const u=e[r][l];if(!u)s.push({row:r,col:l,isCapture:!1});else{u[0]===i&&s.push({row:r,col:l,isCapture:!0});break}r+=f,l+=c}}return s}function D(e,t,o,n){const s=[],i=n==="w"?"b":"w";for(const[f,c]of I.n){const r=t+f,l=o+c;if(r<0||r>7||l<0||l>7)continue;const u=e[r][l];u?u[0]===i&&s.push({row:r,col:l,isCapture:!0}):s.push({row:r,col:l,isCapture:!1})}return s}function G(e,t,o,n){const s=[],i=n==="w"?"b":"w";for(const[f,c]of I.b){let r=t+f,l=o+c;for(;r>=0&&r<=7&&l>=0&&l<=7;){const u=e[r][l];if(!u)s.push({row:r,col:l,isCapture:!1});else{u[0]===i&&s.push({row:r,col:l,isCapture:!0});break}r+=f,l+=c}}return s}function H(e,t,o,n){const s=[],i=n==="w"?"b":"w";for(const[f,c]of I.q){let r=t+f,l=o+c;for(;r>=0&&r<=7&&l>=0&&l<=7;){const u=e[r][l];if(!u)s.push({row:r,col:l,isCapture:!1});else{u[0]===i&&s.push({row:r,col:l,isCapture:!0});break}r+=f,l+=c}}return s}function J(e,t,o,n){const s=e[t.row][t.col];if(s==="wk"&&(n.wl=n.wr=!1),s==="bk"&&(n.bl=n.br=!1),s==="wr"&&(t.col===0&&(n.wl=!1),t.col===7&&(n.wr=!1)),s==="br"&&(t.col===0&&(n.bl=!1),t.col===7&&(n.br=!1)),o!=null&&o.isCapture){const i=e[o.row][o.col];i==="wr"&&(o.col===0&&(n.wl=!1),o.col===7&&(n.wr=!1)),i==="br"&&(o.col===0&&(n.bl=!1),o.col===7&&(n.br=!1))}}function B(e,t,o,n,s,i,f){if(f)t[s.row][s.col]=e[o][n][0]+f,t[o][n]=null;else if(t[s.row][s.col]=e[o][n],t[o][n]=null,s!=null&&s.isCastle){const c=n===2?0:7,r=n===2?3:5,l=i.find(u=>u.row===o&&u.col===c&&u.alive);l.col=r,t[o][r]=e[o][c],t[o][c]=null}}function L(e,t,o,n){const s=o[0];if(o[1]==="p")return R(e,t,s);if(o[1]==="r")return $(n,e,t);if(o[1]==="n")return E(e,t);if(o[1]==="b")return Q(n,e,t);if(o[1]==="q")return U(n,e,t);if(o[1]==="k")return F(e,t)}const N=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];function O(e,t,o,n,s,i,f,c,r){const l=[],u=n==="w"?"b":"w",a=s(e,u,c,r);for(const[g,m]of N){const p=t+g,C=o+m;if(p<0||p>7||C<0||C>7)continue;const M=e[p][C];M?M[0]===u&&l.push({row:p,col:C,isCapture:!0}):l.push({row:p,col:C,isCapture:!1})}const w=i(e,n,c,r),k=n==="w"?f.wl:f.bl,h=n==="w"?f.wr:f.br,v=n==="w"?7:0;return w||(k&&e[v][1]===null&&e[v][2]===null&&e[v][3]===null&&!a.some(g=>g.row===v&&[1,2,3].includes(g.col))?l.push({row:v,col:2,isCastle:!0}):h&&e[v][5]===null&&e[v][6]===null&&!a.some(g=>g.row===v&&[5,6].includes(g.col))&&l.push({row:v,col:6,isCastle:!0})),l}const X={p:1,n:3,b:3,r:5,q:9,k:0},Y={n:[[0,.1,.2,.2,.2,.2,.1,0],[.1,.3,.5,.5,.5,.5,.3,.1],[.2,.5,.6,.65,.65,.6,.5,.2],[.2,.55,.65,.7,.7,.65,.55,.2],[.2,.5,.65,.7,.7,.65,.5,.2],[.2,.55,.6,.65,.65,.6,.55,.2],[.1,.3,.5,.55,.55,.5,.3,.1],[0,.1,.2,.2,.2,.2,.1,0]],b:[[0,.2,.2,.2,.2,.2,.2,0],[.2,.4,.4,.4,.4,.4,.4,.2],[.2,.6,.6,.6,.6,.6,.6,.2],[.2,.5,.5,.6,.6,.5,.5,.2],[.2,.4,.6,.6,.6,.6,.4,.2],[.2,.6,.6,.6,.6,.6,.6,.2],[.2,.5,.4,.4,.4,.4,.5,.2],[0,.2,.2,.2,.2,.2,.2,0]],r:[[.25,.25,.25,.25,.25,.25,.25,.25],[.5,.75,.75,.75,.75,.75,.75,.5],[0,.25,.25,.25,.25,.25,.25,0],[0,.25,.25,.25,.25,.25,.25,0],[0,.25,.25,.25,.25,.25,.25,0],[0,.25,.25,.25,.25,.25,.25,0],[0,.25,.25,.25,.25,.25,.25,0],[.25,.25,.25,.5,.5,.25,.25,.25]],q:[[0,.2,.2,.3,.3,.2,.2,0],[.2,.4,.4,.4,.4,.4,.4,.2],[.2,.4,.5,.5,.5,.5,.4,.2],[.3,.4,.5,.5,.5,.5,.4,.3],[.4,.4,.5,.5,.5,.5,.4,.3],[.2,.5,.5,.5,.5,.5,.4,.2],[.2,.4,.5,.4,.4,.4,.4,.2],[0,.2,.2,.3,.3,.2,.2,0]],p:[[.8,.8,.8,.8,.8,.8,.8,.8],[.7,.7,.7,.7,.7,.7,.7,.7],[.3,.3,.4,.5,.5,.4,.3,.3],[.25,.25,.3,.45,.45,.3,.25,.25],[.2,.2,.2,.4,.4,.2,.2,.2],[.25,.15,.1,.2,.2,.1,.15,.25],[.25,.3,.3,0,0,.3,.3,.25],[.2,.2,.2,.2,.2,.2,.2,.2]],k:[[.2,.3,.1,0,0,.1,.3,.2],[.2,.3,.1,0,0,.1,.3,.2],[.2,.3,.1,0,0,.1,.3,.2],[.2,.3,.1,0,0,.1,.3,.2],[.2,.3,.1,0,0,.1,.3,.2],[.3,.4,.2,.1,.1,.2,.4,.3],[.5,.6,.3,.2,.2,.3,.6,.5],[.8,1,.8,.6,.6,.8,1,.8]]},Z={n:[[0,.1,.2,.2,.2,.2,.1,0],[.1,.3,.5,.55,.55,.5,.3,.1],[.2,.55,.6,.65,.65,.6,.55,.2],[.2,.5,.65,.7,.7,.65,.5,.2],[.2,.55,.65,.7,.7,.65,.55,.2],[.2,.5,.6,.65,.65,.6,.5,.2],[.1,.3,.5,.5,.5,.5,.3,.1],[0,.1,.2,.2,.2,.2,.1,0]],b:[[0,.2,.2,.2,.2,.2,.2,0],[.2,.5,.4,.4,.4,.4,.5,.2],[.2,.6,.6,.6,.6,.6,.6,.2],[.2,.4,.6,.6,.6,.6,.4,.2],[.2,.5,.5,.6,.6,.5,.5,.2],[.2,.6,.6,.6,.6,.6,.6,.2],[.2,.4,.4,.4,.4,.4,.4,.2],[0,.2,.2,.2,.2,.2,.2,0]],r:[[.25,.25,.25,.5,.5,.25,.25,.25],[0,.25,.25,.25,.25,.25,.25,0],[0,.25,.25,.25,.25,.25,.25,0],[0,.25,.25,.25,.25,.25,.25,0],[0,.25,.25,.25,.25,.25,.25,0],[0,.25,.25,.25,.25,.25,.25,0],[.5,.75,.75,.75,.75,.75,.75,.5],[.25,.25,.25,.25,.25,.25,.25,.25]],q:[[0,.2,.2,.3,.3,.2,.2,0],[.2,.4,.5,.4,.4,.4,.4,.2],[.2,.5,.5,.5,.5,.5,.4,.2],[.4,.4,.5,.5,.5,.5,.4,.3],[.3,.4,.5,.5,.5,.5,.4,.3],[.2,.4,.5,.5,.5,.5,.4,.2],[.2,.4,.4,.4,.4,.4,.4,.2],[0,.2,.2,.3,.3,.2,.2,0]],p:[[.2,.2,.2,.2,.2,.2,.2,.2],[.25,.3,.3,0,0,.3,.3,.25],[.25,.15,.1,.2,.2,.1,.15,.25],[.2,.2,.2,.4,.4,.2,.2,.2],[.25,.25,.3,.45,.45,.3,.25,.25],[.3,.3,.4,.5,.5,.4,.3,.3],[.7,.7,.7,.7,.7,.7,.7,.7],[.8,.8,.8,.8,.8,.8,.8,.8]],k:[[.8,1,.8,.6,.6,.8,1,.8],[.5,.6,.3,.2,.2,.3,.6,.5],[.3,.4,.2,.1,.1,.2,.4,.3],[.2,.3,.1,0,0,.1,.3,.2],[.2,.3,.1,0,0,.1,.3,.2],[.2,.3,.1,0,0,.1,.3,.2],[.2,.3,.1,0,0,.1,.3,.2],[.2,.3,.1,0,0,.1,.3,.2]]},A=e=>e.map(t=>({...t}));function P(e,t,o,n,s,i,f){const c=o[0];let r=[];return o[1]==="p"&&(r=j(n,e,t,c)),o[1]==="r"&&(r=z(n,e,t,c)),o[1]==="n"&&(r=D(n,e,t,c)),o[1]==="b"&&(r=G(n,e,t,c)),o[1]==="q"&&(r=H(n,e,t,c)),o[1]==="k"&&(r=O(n,e,t,c,T,x,f,s,i)),_(r,e,t,n,c,s,i)}function _(e,t,o,n,s,i,f){return e.filter(c=>{const r=A(i),l=A(f),u=s==="w",a=u?r:l,w=u?l:r,k=n.map(p=>[...p]);c!=null&&c.isCapture&&(w.find(p=>p.row===c.row&&p.col===c.col&&p.alive).alive=!1),B(n,k,t,o,c,a);const h=a.find(p=>p.row===t&&p.col===o&&p.alive);h.row=c.row,h.col=c.col;const v=a.find(p=>p.type==="k"),g=v.row,m=v.col;for(const p of w){if(!p.alive)continue;const C=p.row,M=p.col,S=k[C][M];if(L(C,M,S,k).some(q=>q.row===g&&q.col===m))return!1}return!0})}function T(e,t,o,n){let s=[];const i=t==="w"?o:n;for(const c of i){if(!c.alive)continue;const r=c.row,l=c.col,u=e[r][l];s.push(...L(r,l,u,e))}return Array.from(new Map(s.map(c=>[`${c.row},${c.col}`,c])).values())}function x(e,t,o,n){const s=t==="b"?"w":"b",f=(t==="w"?o:n).find(a=>a.type==="k"&&a.alive),{row:c,col:r}=f;return T(e,s,o,n).some(a=>a.row===c&&a.col===r)}function b(e,t,o,n,s){const i=t==="w",f=i?n.filter(u=>u.alive):o.filter(u=>u.alive),r=x(e,i?"b":"w",o,n);return f.some(u=>P(u.row,u.col,e[u.row][u.col],e,o,n,s).length>0)?0:r?t==="w"?-1e3:1e3:0}function o0(e,t,o,n,s){const i=b(e,t,o,n,s);if(i!==0)return i;let f=0;const c=(r,l)=>{for(const u of r){if(!u.alive)continue;const a=X[u.type],w=l?Y[u.type][u.row][u.col]:Z[u.type][u.row][u.col];f+=(l?-1:1)*(a+w)}};return c(o,!0),c(n,!1),Math.round(f*1e3)}function t0(e,t,o,n,s){const i=[],r=(s==="w"?t:o).filter(l=>l.alive);for(const l of r){const u=l.row,a=l.col,w=e[u][a],k=P(u,a,w,e,t,o,n);for(const h of k)i.push({frow:u,fcol:a,move:h})}return i}function n0(e,t){const o={p:1,n:3,b:3,r:5,q:9,k:1e3};function n(s){const{frow:i,fcol:f,move:c}=s,r=t[i][f],l=t[c.row][c.col];let u=0;if(l){const w=o[r[1]],k=o[l[1]];u+=10*k-w}r[1]==="p"&&(c.row===0||c.row===7)&&(u+=90);const a=[[3,3],[3,4],[4,3],[4,4]];for(const[w,k]of a)if(c.row===w&&c.col===k){u+=3;break}return u-=o[r[1]]*.1,u}return e.sort((s,i)=>n(i)-n(s))}function V(e,t,o,n,s,i,f,c){const r=e.map(C=>[...C]),l=A(s),u=A(i),a={...f},{row:w,col:k}=t,h=n==="w",v=h?l:u,g=h?u:l,m=a,p=v.find(C=>C.row===o.row&&C.col===o.col&&C.alive);return t!=null&&t.isCapture&&(g.find(C=>C.row===w&&C.col===k&&C.alive).alive=!1),p.row=w,p.col=k,c?(p.type=c,B(e,r,o.row,o.col,t,v,c)):(B(e,r,o.row,o.col,t,v),J(e,o,t,m)),{newBoard:r,cloneWhite:l,cloneBlack:u,castling:m}}function K(e,t,o,n,s,i,f,c,r){if(s===0)return{score:o0(e,r,t,o,n),move:null};const l=t0(e,t,o,n,r),u=n0(l,e).slice(0,20);let a=[];if(c){let w=-1/0;if(l.length===0)return{score:-1/0,move:null};for(const h of u){let v=null;const g=h.frow,m=h.fcol,p=h.move.row,C={row:g,col:m};e[g][m][1]==="p"&&(p===0||p===7)&&(v="q");const{newBoard:M,cloneWhite:S,cloneBlack:W,castling:q}=V(e,h.move,C,r,t,o,n,v),{score:d}=K(M,S,W,q,s-1,i,f,!1,"w");if(d>w?(w=d,a=[h]):d===w&&a.push(h),i=Math.max(i,d),f<=i)break}const k=a[Math.floor(Math.random()*a.length)];return{score:w,move:k}}else{let w=1/0;if(l.length===0)return{score:1/0,move:null};for(const h of u){let v=null;const g=h.frow,m=h.fcol,p=h.move.row,C={row:g,col:m};e[g][m][1]==="p"&&(p===0||p===7)&&(v="q");const{newBoard:M,cloneWhite:S,cloneBlack:W,castling:q}=V(e,h.move,C,r,t,o,n,v),{score:d}=K(M,S,W,q,s-1,i,f,!0,"b");if(d<w?(w=d,a=[h]):d===w&&a.push(h),f=Math.min(f,d),f<=i)break}const k=a[Math.floor(Math.random()*a.length)];return{score:w,move:k}}}function e0(e,t,o,n,s){let i=0;s==="easy"&&(i=2),s==="medium"&&(i=3),s==="hard"&&(i=4);const{move:f}=K(e,t,o,n,i,-1/0,1/0,!0,"b"),c=f.frow,r=f.fcol;return{srcPiece:o.find(u=>u.row===c&&u.col===r),move:f.move}}self.onmessage=function(e){const{board:t,whitePieces:o,blackPieces:n,castlingRights:s,difficulty:i}=e.data,f=e0(t,o,n,s,i);self.postMessage(f)}})();
